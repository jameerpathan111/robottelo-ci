---
- name: satellite6-populate-template
  hosts: localhost
  vars:
    username: admin
    password: changeme
    server: ansible_facts['fqdn']
  tasks:
    - name: Create lifecycle-environments
      include_tasks: tasks/create_lifecycle_environment.yml
      loop:
        - lifecycle_environment_name: "DEV"
          organization: "Default Organization"
          prior: "Library"
        - lifecycle_environment_name: "QE"
          organization: "Default Organization"
          prior: "DEV"
        - lifecycle_environment_name: "PROD"
          organization: "Default Organization"
          prior: "QE"

    - name: Update the DOWNLOAD_POLICY to sync content.
      include_tasks: tasks/satellite_setting.yml
      loop:
        - setting_name: "default_download_policy"
          setting_value: "{{ DOWNLOAD_POLICY }}"

    - name: Check if manifest already present or not.
      stat:
        path: "{{ lookup('env','HOME') }}/manifest-latest.zip"
        register: manifest_latest

    - name: Fetch the manifest from server.
        get_url:
          url: "{{ MANIFEST_LOCATION_URL }}"
          dest: "{{ lookup('env','HOME') }}/manifest-latest.zip"
        when: manifest_latest.stat.exists == true

    - name: Import Manifest.
        include_tasks: tasks/manifest_upload.yml
        loop:
          - organization: "Default Organization"
            manifest_path: "{{ lookup('env','HOME') }}/manifest-latest.zip"
    - name: Enable Red Hat repositories
        include_tasks: tasks/create_repository_set.yml
        loop:
          - organization: "Default Organization"
            repo_name: "Red Hat Enterprise Linux 7 Server (Kickstart)"
            product: "Red Hat Enterprise Linux Server"
            releasever: "7.6"
            basearch: "x86_64"
          - organization: "Default Organization"
            repo_name: "Red Hat Enterprise Linux 6 Server (Kickstart)"
            product: "Red Hat Enterprise Linux Server"
            releasever: "6.10"
            basearch: "x86_64"
          - organization: "Default Organization"
            repo_name: "Red Hat Enterprise Linux 7 Server (RPMs)"
            product: "Red Hat Enterprise Linux Server"
            releasever: "7Server"
            basearch: "x86_64"
          - organization: "Default Organization"
            repo_name: "Red Hat Enterprise Linux 6 Server (RPMs)"
            product: "Red Hat Enterprise Linux Server"
            releasever: "6Server"
            basearch: "x86_64"
          - organization: "Default Organization"
            repo_name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server"
            product: "Red Hat Software Collections for RHEL Server"
            releasever: "7Server"
            basearch: "x86_64"

    - name: Enable Red Hat repositories when SATELLITE_DISTRIBUTION = "BETA"
        include_tasks: tasks/create_repository_set.yml
        loop:
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Maintenance 6 Beta (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Tools 6 Beta (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Tools 6 Beta (for RHEL 6 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Capsule 6 Beta (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Satellite Capsule Beta"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Capsule 6 Beta (for RHEL 6 Server) (RPMs)"
              product: "Red Hat Satellite Capsule Beta"
              releasever: ""
              basearch: "x86_64"
        when: "{{ SATELLITE_DISTRIBUTION }}" == "BETA"

    - name: Enable Foreman-Maintain repos for SATELLITE_DISTRIBUTION != "BETA"
        include_tasks: tasks/create_repository_set.yml
        loop:
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Maintenance 6 (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
        when:
          - "{{ SATELLITE_DISTRIBUTION }}" != "BETA"

    - name: Enable Red Hat repositories when SATELLITE_DISTRIBUTION = "BETA"
        include_tasks: tasks/create_repository_set.yml
        loop:
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Tools {{ SAT_VERSION }} (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Tools {{ SAT_VERSION }} (for RHEL 6 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Capsule {{ SAT_VERSION }} (for RHEL 7 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
          - organization: "Default Organization"
              repo_name: "Red Hat Satellite Capsule {{ SAT_VERSION }} (for RHEL 6 Server) (RPMs)"
              product: "Red Hat Enterprise Linux Server"
              releasever: ""
              basearch: "x86_64"
        when: "{{ SATELLITE_DISTRIBUTION }}" == "GA"

    - name: Synchronize all repositories except for Puppet repositories which don't have URLs

    - name: Get all repositories.
      foreman_search_facts:
        username: "{{ username }}"
        password: "{{ password }}"
        server_url: "{{ server }}"
        resource: repositories
      register: repositories

    - name: Kick off repository Sync tasks. except for Puppet repositories which don't have URLs
      katello_sync:
        username: "{{ username }}"
        password: "{{ password }}"
        server_url: "{{ server }}"
        product: "{{ item.product.name }}"
        repository:  "{{ item.name }}"
        organization: "Default Organization"
      loop: "{{ repositories.resources }}"
      when: item.url  # Not all repositories have a URL
      async: 999999
      poll: 0
      register: repo_sync_sleeper

    - name: Wait until all Syncs have finished
      async_status:
        jid: "{{ repo_sync_sleeper_item.ansible_job_id }}"
      loop: "{{ repo_sync_sleeper.results }}"
      loop_control:
        loop_var: repo_sync_sleeper_item
      when: repo_sync_sleeper_item.ansible_job_id is defined  # Skip items that were skipped in the previous task
      register: async_job_result
      until: async_job_result.finished
      retries: 999
      delay: 10

    - name: Wait until all Syncs have finished
      async_status:
        jid: "{{ repo_sync_sleeper_item.ansible_job_id }}"
      loop: "{{ repo_sync_sleeper.results }}"
      loop_control:
        loop_var: repo_sync_sleeper_item
      when: repo_sync_sleeper_item.ansible_job_id is defined  # Skip items that were skipped in the previous task
      register: async_job_result
      until: async_job_result.finished
      retries: 999
      delay: 10

    - name:  Create Repos and Sync Repositories. Create both Tools for RHEL6 and RHEL7 and Capsule for RHEL6 and RHEL7
        include_tasks: tasks/create_repository.yml
        loop:
          - organization: "{{ organization }}"
            product: "{{ RHEL6_TOOLS_PRD }}"
            repo_name: "{{ RHEL6_TOOLS_REPO }}"
            repo_url: "{{ RHEL6_TOOLS_URL }}"
            download_policy: "{{ DOWNLOAD_POLICY }}"
          - organization: "{{ organization }}"
              product: "{{ RHEL7_TOOLS_PRD }}"
              repo_name: "{{ RHEL7_TOOLS_REPO }}"
              repo_url: "{{ RHEL7_TOOLS_URL }}"
              download_policy: "{{ DOWNLOAD_POLICY }}"
          - organization: "{{ organization }}"
              product: "{{ SAT6C7_PRODUCT }}"
              repo_name: "{{ CAPSULE7_REPO }}"
              repo_url: "{{ CAPSULE7_URL }}"
              download_policy: "{{ DOWNLOAD_POLICY }}"
          - organization: "{{ organization }}"
              product: "{{ SAT6M7_PRODUCT }}"
              repo_name: "{{ MAINTAIN7_REPO }}"
              repo_url: "{{ MAINTAIN7_URL }}"
              download_policy: "{{ DOWNLOAD_POLICY }}"
        when:
          - "{{ SATELLITE_DISTRIBUTION }}" != "GA"
          - "{{ SATELLITE_DISTRIBUTION }}" != "BETA"

    - name:  Create Repos and Sync Repositories for SAT_VERSION = "6.2". Create both Tools for RHEL6 and RHEL7 and Capsule for RHEL6 and RHEL7
        include_tasks: tasks/create_repository.yml
        loop:
          - organization: "{{ organization }}"
            product: "{{ SAT6C6_PRODUCT }}"
            repo_name: "{{ CAPSULE6_REPO }}"
            repo_url: "{{ CAPSULE6_URL }}"
            download_policy: "{{ DOWNLOAD_POLICY }}"
        when:
          - "{{ SATELLITE_DISTRIBUTION }}" != "GA"
          - "{{ SATELLITE_DISTRIBUTION }}" !== "BETA"
          - "{{ SAT_VERSION }}" == "6.2"

    - name: Create content views
        include_tasks: tasks/create_content_view.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "RHEL 7 CV"
          - organization: "{{ organization }}"
            cv_name: "RHEL 6 CV"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 6 CV"

    - name: Add content to content views RHEL 7 CV and RHEL 6 CV
        include_tasks: tasks/add_content_to_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "RHEL 7 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 7 Server Kickstart x86_64 7.6"
          - organization: "{{ organization }}"
            cv_name: "RHEL 7 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server"
          - organization: "{{ organization }}"
            cv_name: "RHEL 7 CV"
            product: "{{ RHEL7_TOOLS_PRD }}"
            repo_name: "{{ RHEL7_TOOLS_REPO }}"
          - organization: "{{ organization }}"
            cv_name: "RHEL 6 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 6 Server Kickstart x86_64 6.10"
          - organization: "{{ organization }}"
            cv_name: "RHEL 6 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 6 Server RPMs x86_64 6Server"
          - organization: "{{ organization }}"
            cv_name: "RHEL 6 CV"
            product: "{{ RHEL6_TOOLS_PRD }}"
            repo_name: "{{ RHEL6_TOOLS_REPO }}"

    - name: Publish and promote RHEL 7 CV and RHEL 6 CV
        include_tasks: tasks/publish_and_promote_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "RHEL 7 CV"
            lifecycle_environment: "DEV"
          - organization: "{{ organization }}"
            cv_name: "RHEL 6 CV"
            lifecycle_environment: "DEV"
    - name: Add content to content views Capsule RHEL 7 CV
        include_tasks: tasks/add_content_to_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "Red Hat Software Collections for RHEL Server"
            repo_name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64 7Server"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "Red Hat Ansible Engine"
            repo_name: "Red Hat Ansible Engine 2 RPMs for Red Hat Enterprise Linux 7 Server x86_64"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "{{ RHEL7_TOOLS_PRD }}"
            repo_name: "{{ RHEL7_TOOLS_REPO }}"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "{{ SAT6C7_PRODUCT }}"
            repo_name: "{{ CAPSULE7_REPO }}"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            product: "{{ SAT6M7_PRODUCT }}"
            repo_name: "{{ MAINTAIN7_REPO }}"
        when:
          - "{{ RHELOS }}" == "7"
    - name: Publish and promote Capsule RHEL 7 CV
        include_tasks: tasks/publish_and_promote_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 7 CV"
            lifecycle_environment: "DEV"
        when:
          - "{{ RHELOS }}" == "7"
    - name: Add content to content views Capsule RHEL 6 CV
        include_tasks: tasks/add_content_to_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 6 CV"
            product: "Red Hat Enterprise Linux Server"
            repo_name: "Red Hat Enterprise Linux 6 Server RPMs x86_64 6Server"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 6 CV"
            product: "{{ RHEL6_TOOLS_PRD }}"
            repo_name: "{{ RHEL6_TOOLS_REPO }}"
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 6 CV"
            product: "{{ SAT6C6_PRODUCT }}"
            repo_name: "{{ CAPSULE6_REPO }}"
        when:
          - "{{ RHELOS }}" != "7"
    - name: Publish and promote Capsule RHEL 6 CV
        include_tasks: tasks/publish_and_promote_cv.yml
        loop:
          - organization: "{{ organization }}"
            cv_name: "Capsule RHEL 6 CV"
            lifecycle_environment: "DEV"
        when:
          - "{{ RHELOS }}" != "7"
    - name: Create activation keys
        include_tasks: tasks/create_activation_key.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-7"
            content_view: "RHEL 7 CV"
            lifecycle_environment: "DEV"
            auto_attach: False
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-6"
            content_view: "RHEL 6 CV"
            lifecycle_environment: "DEV"
            auto_attach: False
          - organization: "{{ organization }}"
            ak_name: ak-capsule-{{ RHELOS }}
            content_view: "RHEL 7 CV"
            lifecycle_environment: "DEV"
            auto_attach: False
    - name: Add Subscriptions to both RHEL6 and RHEL7 Activation keys. Line 326 onwards
    - name: Add Subscriptions to part1
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-7"
            subscription_name: "Red Hat Satellite Infrastructure Subscription"
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-6"
            subscription_name: "Red Hat Satellite Infrastructure Subscription"
    - name: Add Subscriptions to part2
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-7"
            subscription_name: "{{ RHEL7_TOOLS_PRD }}"
          - organization: "{{ organization }}"
            ak_name: "ak-rhel-6"
            subscription_name: "{{ RHEL6_TOOLS_PRD }}"
        when:
          - "{{ SATELLITE_DISTRIBUTION }}" != "GA"
          - "{{ SATELLITE_DISTRIBUTION }}" != "BETA"
    - name: Add Subscriptions to part3. Doesn't seem right. check once more. issue CAPSULE7_SUBS_ID
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            subscription_name: "Red Hat Satellite Infrastructure Subscription"
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            subscription_name: "{{ SAT6M7_PRODUCT }}"
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            subscription_name: "Red Hat Enterprise Linux Server, Premium (Physical or Virtual Nodes)"
        when:
          - "{{ RHELOS }}" == "7"

    - name: Add Subscriptions to part4
        include_tasks: tasks/ak_content_override.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            label: rhel-server-rhscl-7-rpms
            override: enabled
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            label: rhel-7-server-ansible-2-rpms
            override: enabled
        when:
          - "{{ RHELOS }}" == "7"
    - name: Add Subscriptions to part5
        include_tasks: tasks/ak_content_override.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            label: rhel-7-server-satellite-maintenance-6-rpms
            override: enabled
        when:
          - "{{ RHELOS }}" == "7"
          - "{{ SATELLITE_DISTRIBUTION }}" == "GA"
    - name: Add Subscriptions to part6
        include_tasks: tasks/ak_content_override.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            label: rhel-7-server-satellite-maintenance-6-beta-rpms
            override: enabled
        when:
          - "{{ RHELOS }}" == "7"
          - "{{ SATELLITE_DISTRIBUTION }}" == "BETA"
    - name: Add Subscriptions to part7.
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-7"
            subscription_name: "{{ RHEL7_TOOLS_PRD }}"
        when:
          - "{{ RHELOS }}" == "7"
          - "{{ SATELLITE_DISTRIBUTION }}" != "BETA"
          - "{{ SATELLITE_DISTRIBUTION }}" != "GA"
    - name: Add Subscriptions to ak-capsule-6 part8.
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-6"
            subscription_name: "{{ SAT6C6_PRODUCT }}"
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-6"
            subscription_name: "Red Hat Satellite Infrastructure Subscription"
        when:
          - "{{ RHELOS }}" != "7"
    - name: Add Subscriptions to ak-capsule-6 part9.
        include_tasks: tasks/add_subscriptions_to_ak.yml
        loop:
          - organization: "{{ organization }}"
            ak_name: "ak-capsule-6"
            subscription_name: "{{ RHEL6_TOOLS_PRD }}"
        when:
          - "{{ RHELOS }}" != "7"
          - "{{ SATELLITE_DISTRIBUTION }}" != "BETA"
          - "{{ SATELLITE_DISTRIBUTION }}" != "GA"
    # Update Domain with Capsule's ID.
    - name: getting Domain name
      command: hostname -d
        register: domain_name

    - name: Update Domain
      foreman_domain:
        name: {{ domain_name.stdout }}
        locations:
          - "{{ location }}"  # To Do, missing var
        organizations:
          - "{{ organization }}"
        server_url: "{{ server }}"
        username: "{{ username }}"
        password: "{{ password }}"
        parameters:
          - name: "dns-id"
            parameter_type: "integer"
            value: 1
        state: present
    - name: Create subnet and associate various entities to it.
    - name: Create Libvirt CR