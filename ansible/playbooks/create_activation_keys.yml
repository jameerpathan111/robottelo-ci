---
- name: create_activation_keys
  hosts: satellite
  vars:
    username: admin
    password: changeme # to do part
    SERVER_HOSTNAME: "{{ lookup('env','SERVER_HOSTNAME') }}"
    server_url: "https://{{ SERVER_HOSTNAME }}"
    SATELLITE_DISTRIBUTION: "{{ lookup('env','SATELLITE_DISTRIBUTION') }}"
    DOWNLOAD_POLICY: "{{ lookup('env','DOWNLOAD_POLICY') }}"
    SAT_VERSION: "{{ lookup('env','SAT_VERSION') }}"
    MANIFEST_LOCATION_URL: "{{ lookup('env', 'MANIFEST_LOCATION_URL') }}"
    RHELOS: "{{ hostvars[inventory_hostname].ansible_distribution_major_version }}"
    organization: "Default Organization"
  tasks:
    - name: Load vars when SATELLITE_DISTRIBUTION == BETA
      include_vars: sat_beta_vars.yml
      when: SATELLITE_DISTRIBUTION == "BETA"
    - name: Load vars when SATELLITE_DISTRIBUTION == GA
      include_vars: sat_ga_vars.yml
      when: SATELLITE_DISTRIBUTION == "GA"
    - name: Load vars when SATELLITE_DISTRIBUTION != ("GA" and "BETA")
      include_vars: sat_internalak_vars.yml
      when:
        - SATELLITE_DISTRIBUTION != "GA"
        - SATELLITE_DISTRIBUTION != "BETA"

    - name: Create lifecycle-environments
      include_tasks: tasks/create_lifecycle_environment.yml
      loop:
        - lifecycle_environment_name: "DEV"
          organization: "{{ organization }}"
          prior: "Library"
        - lifecycle_environment_name: "QE"
          organization: "{{ organization }}"
          prior: "DEV"
        - lifecycle_environment_name: "PROD"
          organization: "{{ organization }}"
          prior: "QE"

    - name: Update the DOWNLOAD_POLICY to sync content.
      include_tasks: tasks/satellite_setting.yml
      loop:
        - setting_name: "default_download_policy"
          setting_value: "{{ DOWNLOAD_POLICY }}"

    - name: Check if manifest already present or not.
      stat:
        path: "/root/manifest-latest.zip"
      register: manifest_latest

    - name: Fetch the manifest from server.
      get_url:
        url: "{{ MANIFEST_LOCATION_URL }}"
        dest: "/root/manifest-latest.zip"
      when: manifest_latest.stat.exists == False

    - name: Import Manifest.
      include_tasks: tasks/manifest_upload.yml
      loop:
        - organization: "{{ organization }}"
          manifest_path: "/root/manifest-latest.zip"

    - name: Enable Red Hat repositories
      include_tasks: tasks/create_repository_set.yml
      loop:
        - organization: "{{ organization }}"
          repo_name: "Red Hat Enterprise Linux 7 Server (Kickstart)"
          product: "Red Hat Enterprise Linux Server"
          releasever: "7.7"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Enterprise Linux 6 Server (Kickstart)"
          product: "Red Hat Enterprise Linux Server"
          releasever: "6.10"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Enterprise Linux 7 Server (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          releasever: "7Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Enterprise Linux 6 Server (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          releasever: "6Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Ansible Engine 2 RPMs for Red Hat Enterprise Linux 7 Server"
          product: "Red Hat Ansible Engine"
          basearch: "x86_64"

    - name: Enable Red Hat repository Red Hat Software Collections for sat 6.7
      include_tasks: tasks/create_repository_set.yml
      loop:
        - organization: "{{ organization }}"
          repo_name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server"
          product: "Red Hat Software Collections (for RHEL Server)"
          releasever: "7Server"
          basearch: "x86_64"
      when: SAT_VERSION == "6.7"

    - name: Enable Red Hat repository Red Hat Software Collections
      include_tasks: tasks/create_repository_set.yml
      loop:
        - organization: "{{ organization }}"
          repo_name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server"
          product: "Red Hat Software Collections for RHEL Server"
          releasever: "7Server"
          basearch: "x86_64"
      when: SAT_VERSION != "6.7"

    - name: Enable Red Hat repositories when SATELLITE_DISTRIBUTION = "BETA"
      include_tasks: tasks/create_repository_set.yml
      loop:
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Maintenance 6 Beta (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Tools 6 Beta (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Tools 6 Beta (for RHEL 6 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Capsule 6 Beta (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Satellite Capsule Beta"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Capsule 6 Beta (for RHEL 6 Server) (RPMs)"
          product: "Red Hat Satellite Capsule Beta"
          basearch: "x86_64"
      when: SATELLITE_DISTRIBUTION == "BETA"

    - name: Enable Red Hat repositories when SATELLITE_DISTRIBUTION = "GA"
      include_tasks: tasks/create_repository_set.yml
      loop:
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Tools {{ SAT_VERSION }} (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Tools {{ SAT_VERSION }} (for RHEL 6 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Capsule {{ SAT_VERSION }} (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Capsule {{ SAT_VERSION }} (for RHEL 6 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
        - organization: "{{ organization }}"
          repo_name: "Red Hat Satellite Maintenance 6 (for RHEL 7 Server) (RPMs)"
          product: "Red Hat Enterprise Linux Server"
          basearch: "x86_64"
      when: SATELLITE_DISTRIBUTION == "GA"

    - name:  Create Repos and Sync Repositories. Create both Tools for RHEL6 and RHEL7 and Capsule for RHEL6 and RHEL7
      include_tasks: tasks/create_repository.yml
      loop:
        - organization: "{{ organization }}"
          product: "{{ RHEL6_TOOLS_PRD }}"
          repo_name: "{{ RHEL6_TOOLS_REPO }}"
          repo_url: "{{ RHEL6_TOOLS_URL }}"
          download_policy: "{{ DOWNLOAD_POLICY }}"
        - organization: "{{ organization }}"
          product: "{{ RHEL7_TOOLS_PRD }}"
          repo_name: "{{ RHEL7_TOOLS_REPO }}"
          repo_url: "{{ RHEL7_TOOLS_URL }}"
          download_policy: "{{ DOWNLOAD_POLICY }}"
        - organization: "{{ organization }}"
          product: "{{ SAT6C7_PRODUCT }}"
          repo_name: "{{ CAPSULE7_REPO }}"
          repo_url: "{{ CAPSULE7_URL }}"
          download_policy: "{{ DOWNLOAD_POLICY }}"
        - organization: "{{ organization }}"
          product: "{{ SAT6M7_PRODUCT }}"
          repo_name: "{{ MAINTAIN7_REPO }}"
          repo_url: "{{ MAINTAIN7_URL }}"
          download_policy: "{{ DOWNLOAD_POLICY }}"
      when:
        - SATELLITE_DISTRIBUTION != "GA"
        - SATELLITE_DISTRIBUTION != "BETA"

    - name: Enable Red Hat repositories
      include_tasks: tasks/sync_all_repositories.yml

    - name: Creat and add content to content views RHEL 7 CV and RHEL 6 CV
      include_tasks: tasks/create_content_view.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "RHEL 7 CV"
          repositories:
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 7 Server Kickstart x86_64 7.6"
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server"
            - product: "{{ RHEL7_TOOLS_PRD }}"
              name: "{{ RHEL7_TOOLS_REPO }}"
        - organization: "{{ organization }}"
          cv_name: "RHEL 6 CV"
          repositories:
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 6 Server Kickstart x86_64 6.10"
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 6 Server RPMs x86_64 6Server"
            - product: "{{ RHEL6_TOOLS_PRD }}"
              name: "{{ RHEL6_TOOLS_REPO }}"

    - name: Add Red Hat Software Collections to content views Capsule RHEL 7 CV for Satellite == 6.7
      include_tasks: tasks/create_content_view.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 7 CV"
          repositories:
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server"
            - product: "Red Hat Ansible Engine"
              name: "Red Hat Ansible Engine 2 RPMs for Red Hat Enterprise Linux 7 Server x86_64"
            - product: "{{ RHEL7_TOOLS_PRD }}"
              name: "{{ RHEL7_TOOLS_REPO }}"
            - product: "{{ SAT6C7_PRODUCT }}"
              name: "{{ CAPSULE7_REPO }}"
            - product: "{{ SAT6M7_PRODUCT }}"
              name: "{{ MAINTAIN7_REPO }}"
            - product: "Red Hat Software Collections (for RHEL Server)"
              name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64 7Server"
      when:
        - RHELOS == "7"
        - SAT_VERSION == "6.7"

    - name: Add Red Hat Software Collections to content views Capsule RHEL 7 CV for Satellite != 6.7
      include_tasks: tasks/create_content_view.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 7 CV"
          repositories:
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 7 Server RPMs x86_64 7Server"
            - product: "Red Hat Ansible Engine"
              name: "Red Hat Ansible Engine 2 RPMs for Red Hat Enterprise Linux 7 Server x86_64"
            - product: "{{ RHEL7_TOOLS_PRD }}"
              name: "{{ RHEL7_TOOLS_REPO }}"
            - product: "{{ SAT6C7_PRODUCT }}"
              name: "{{ CAPSULE7_REPO }}"
            - product: "{{ SAT6M7_PRODUCT }}"
              name: "{{ MAINTAIN7_REPO }}"
            - product: "Red Hat Software Collections for RHEL Server"
              name: "Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64 7Server"
      when:
        - RHELOS == "7"
        - SAT_VERSION != "6.7"

    - name: Add content to content views Capsule RHEL 6 CV
      include_tasks: tasks/create_content_view.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 6 CV"
          repositories:
            - product: "Red Hat Enterprise Linux Server"
              name: "Red Hat Enterprise Linux 6 Server RPMs x86_64 6Server"
            - product: "{{ RHEL6_TOOLS_PRD }}"
              name: "{{ RHEL6_TOOLS_REPO }}"
            - product: "{{ SAT6C6_PRODUCT }}"
              name: "{{ CAPSULE6_REPO }}"
      when: RHELOS != "7"

    - name: Publish and promote Capsule RHEL 7 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 7 CV"
          lifecycle_environment:
            - Library
            - DEV
      when:
        - RHELOS == "7"

    - name: Publish and promote RHEL 7 CV and RHEL 6 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "RHEL 7 CV"
          lifecycle_environment: "DEV"
        - organization: "{{ organization }}"
          cv_name: "RHEL 6 CV"
          lifecycle_environment:
            - Library
            - DEV

    - name: Publish and promote Capsule RHEL 6 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 6 CV"
          lifecycle_environment:
            - Library
            - DEV
      when:
        - RHELOS != "7"

    - name: Publish and promote Capsule RHEL 7 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 7 CV"
          lifecycle_environment:
            - Library
            - DEV
      when:
        - RHELOS == "7"

    - name: Publish and promote RHEL 7 CV and RHEL 6 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "RHEL 7 CV"
          lifecycle_environment:
            - Library
            - DEV
        - organization: "{{ organization }}"
          cv_name: "RHEL 6 CV"
          lifecycle_environment:
            - Library
            - DEV

    - name: Publish and promote Capsule RHEL 6 CV
      include_tasks: tasks/publish_and_promote_cv.yml
      loop:
        - organization: "{{ organization }}"
          cv_name: "Capsule RHEL 6 CV"
          lifecycle_environment:
            - Library
            - DEV
      when:
        - RHELOS != "7"

    - name: Create activation keys
      include_tasks: tasks/create_activation_key.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-{{ RHELOS }}"
          content_view: "RHEL {{ RHELOS }} CV"
          lifecycle_environment: "DEV"
          auto_attach: False
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-7"
          content_view: "RHEL 7 CV"
          lifecycle_environment: "DEV"
          auto_attach: False
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-6"
          content_view: "RHEL 6 CV"
          lifecycle_environment: "DEV"
          auto_attach: False


    - name: Add Subscriptions to ak-rhl-7 and ak-rhel-6 part1
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-7"
          subscriptions:
            - name: "Red Hat Satellite Infrastructure Subscription"
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-6"
          subscriptions:
            - name: "Red Hat Satellite Infrastructure Subscription"

    - name: Add Subscriptions to ak-rhel-7 and ak-rhel-6 part2
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-7"
          subscriptions:
            - name: "{{ RHEL7_TOOLS_PRD }}"
            - name: "Red Hat Satellite Infrastructure Subscription"
        - organization: "{{ organization }}"
          ak_name: "ak-rhel-6"
          subscriptions:
            - name: "{{ RHEL6_TOOLS_PRD }}"
            - name: "Red Hat Satellite Infrastructure Subscription"
      when:
        - SATELLITE_DISTRIBUTION != "GA"
        - SATELLITE_DISTRIBUTION != "BETA"

    - name: Add Subscriptions to ak-capsule-7 part1
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-7"
          subscriptions:
            - name: "{{ SAT6C7_PRODUCT }}"
            - name: "{{ SAT6M7_PRODUCT }}"
            - name: "Red Hat Satellite Infrastructure Subscription"
            - name: "Red Hat Enterprise Linux Server, Premium (Physical or Virtual Nodes)"
            - name: "{{ RHEL7_TOOLS_PRD }}"
      when:
        - RHELOS == "7"
        - SATELLITE_DISTRIBUTION != "GA"
        - SATELLITE_DISTRIBUTION != "BETA"

    - name: Add Subscriptions to ak-capsule-7 part2
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-7"
          subscriptions:
            - name: "Red Hat Satellite Infrastructure Subscription"
            - name: "Red Hat Enterprise Linux Server, Premium (Physical or Virtual Nodes)"
      when:
        - RHELOS == "7"
        - SATELLITE_DISTRIBUTION == "GA" or SATELLITE_DISTRIBUTION == "BETA"

    - name: Add Subscriptions to ak-capsule-6 part1
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-6"
          subscriptions:
            - name: "Red Hat Satellite Infrastructure Subscription"
            - name: "{{ SAT6C6_PRODUCT }}"
            - name: "{{ RHEL6_TOOLS_PRD }}"
      when:
        - RHELOS != "7"
        - SATELLITE_DISTRIBUTION != "GA"
        - SATELLITE_DISTRIBUTION != "BETA"

    - name: Add Subscriptions to ak-capsule-6 part2
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-6"
          subscriptions:
            - name: "Red Hat Satellite Infrastructure Subscription"
      when:
        - RHELOS != "7"
        - SATELLITE_DISTRIBUTION == "GA" or SATELLITE_DISTRIBUTION == "BETA"


    - name: ak-capsule-7 content-override part1
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-7"
          content_overrides:
            - label: rhel-server-rhscl-7-rpms
              override: enabled
            - label: rhel-7-server-ansible-2-rpms
              override: enabled
      when:
          - RHELOS == "7"

    - name: ak-capsule-7 content-override part2
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-7"
          content_overrides:
            - label: rhel-server-rhscl-7-rpms
              override: enabled
            - label: rhel-7-server-ansible-2-rpms
              override: enabled
            - label: rhel-7-server-satellite-maintenance-6-rpms
              override: enabled
      when:
        - RHELOS == "7"
        - SATELLITE_DISTRIBUTION == "GA"

    - name: ak-capsule-7 content-override part3
      include_tasks: tasks/add_subscriptions_to_ak.yml
      loop:
        - organization: "{{ organization }}"
          ak_name: "ak-capsule-7"
          content_overrides:
            - label: rhel-server-rhscl-7-rpms
              override: enabled
            - label: rhel-7-server-ansible-2-rpms
              override: enabled
            - label: rhel-7-server-satellite-maintenance-6-beta-rpms
              override: enabled
      when:
        - RHELOS == "7"
        - SATELLITE_DISTRIBUTION == "BETA"
